#!/usr/bin/env bash
export PATH="$VWC_EXECUTIONPLANE_APIINTERNALPATH_STACK"
. executionplane-invoke "$0 $@"
selectedNode="${@: -1}"
if [[ ! -d /vcw/pwd/${selectedNode} ]]; then executionplane-error "${selectedNode}: Does not exist!"; cd /vcw/pwd; executionplane-complete; exit; fi

cd /vcw/pwd/${selectedNode}
imageTag=$(git describe --tags HEAD)

if [[ $# -gt 1 ]] ; then command=$1; else command="up"; fi
if [[ " up down " != *"$command"* ]]; then command="up"; fi

if [[ ! -f _stack/settings.stack ]] ; then executionplane-error "Stack settings file does not exist!"; cd /vcw/pwd; executionplane-complete; exit; fi
(
	export VCW_STACK_URLPREFIX="vcw_stack"
	export VCW_STACK_NETWORKLOCAL="vcw_stack"
	export VCW_STACK_NETWORKGLOBAL="vcw_stack_global"
  if [[ "$VCW_STACK_GLOBAL_STACKNAMES" == *","* ]] ; then export VCW_STACK_STACKPREFIX=$(echo ${VCW_STACK_GLOBAL_STACKNAMES} | cut -d',' -f1); else export VCW_STACK_STACKPREFIX="vcw_stack"; fi
	. _stack/settings.stack;
	deploy-${command}
)
cd /vcw/pwd
executionplane-complete
