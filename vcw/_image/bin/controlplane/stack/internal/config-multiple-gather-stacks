#!/usr/bin/env bash
DOLLAR="$"

echo $'#!/usr/bin/env bash\n' > _stack/settings.tmp
#IFS=',' read -r -a stacks <<< "$(echo ${VCW_STACK_GLOBAL_STACKS} | tr '\\' ' ' | tr '\n' ' ')"
IFS=',' read -r -a stacks <<< "${VCW_STACK_GLOBAL_STACKS}"
IFS=',' read -r -a stackNames <<< "${VCW_STACK_GLOBAL_STACKNAMES}"
IFS=',' read -r -a stackNamesPrevious <<< "${VCW_STACK_GLOBAL_STACKNAMES_PREVIOUS}"
for stackNumber in ${!stacks[@]};
do
	stack=${stacks[stackNumber]}
	stackName=${stackNames[stackNumber]}
	stackNamePrevious=${stackNamesPrevious[stackNumber]}

	destination=_stack/stacks/$stackName.docker-compose.yml.tmp
	cp /vcw/pwd/${stack}/_stack/stacks/$stackNamePrevious.docker-compose.yml $destination
	if [[ "${stackNamePrevious^^}" != "${stackName^^}" ]] ; then
		sed -i -e "s/${stackNamePrevious^^}_/${stackName^^}_/g" $destination
		sed -i -e "s/${stackNamePrevious}/${stackName}/g" $destination
	fi

	echo "$(sed -n "/# START SETTINGS/,/# END SETTINGS/p" /vcw/pwd/${stack}/_stack/settings)" >> _stack/settings.tmp
	if [[ "${stackNamePrevious^^}" != "${stackName^^}" ]] ; then
		sed -i -e "s/${stackNamePrevious^^}_/${stackName^^}_/g" _stack/settings.tmp
		sed -i -e "s/${stackNamePrevious}/${stackName}/g" _stack/settings.tmp
	fi
done;
