#!/usr/bin/env bash
export PATH="$VCW_EXECUTIONPLANE_APIINTERNALPATH_SOLUTION"
. executionplane-invoke "$0 $@"
selectedNode="${@: -1}"
if [[ ! -d /vcw/pwd/${selectedNode} ]]; then executionplane-error "${selectedNode}: Does not exist!"; cd /vcw/pwd; executionplane-complete; exit; fi

cd /vcw/pwd/${selectedNode}
imageTag=$(git describe --tags HEAD)

if [[ $# -gt 1 ]] ; then command="$1"; shift; else command="all"; fi
if [[ $# -gt 1 ]] ; then component="$1"; shift; fi
if [[ "$component" == "." ]] ; then component=""; fi

if [[ ! -f _solution/configuration ]] ; then executionplane-error "Solution configuration file does not exist!"; cd /vcw/pwd; executionplane-complete; exit; fi
if [[ "$component" == "" ]] ; then componentPath="_solution"; else componentPath="_solution/${component}"; fi
if [[ ! -f ${componentPath}/_configuration/configuration ]] ; then executionplane-error "Solution component configuration file does not exist!"; cd /vcw/pwd; executionplane-complete; exit; fi
(
	. set-config
	case $command in
		all)
#			config module $component $imageName
#			config component $component $imageName
#			config deploy $component $imageName
#			config volume $component $imageName
#			config solution $component $imageName
		;;
		component)
#			config-component $imageName $component
#			config-descendant $imageName $component component
		;;
		deploy)
#			config-deploy $imageName $component
#			config-descendant $imageName $component deploy
		;;
		module)
			config-module $selectedNode $component
#			config-descendant $imageName $component module
		;;
		solution)
#			config-solution . $imageName
		;;
		volume)
#			config-volume $imageName $component
#			config-descendant $imageName $component volume
		;;
		*)
			executionplane-error "Method not recognised: $1."
		;;
	esac
	)
cd /vcw/pwd
executionplane-complete
