#!/usr/bin/env bash

mode="$1" # backup or restore
collection="$2" # internal, external, package, module

# check that backup repository exists - halt if not
repo="${VWC_REALM_RUNTIME}/${VWC_ECOSYSTEM_RUNTIME}.backup.$collection"
if [[ ! -d "$repo" ]] ; then
  executionplane-error "There is no back repository for the collection requested: ${VWC_ECOSYSTEM_RUNTIME}.backup.$collection"
  exit 0
fi

# run backup or restore routine
if [[ "$mode" == "restore" ]] ; then
  for f in $repo/vcwc/assets/*
  do
    executionplane --silent tar -xvf $f
  done;
else
  executionplane rm $repo/vcwc/assets/*.tar
  for f in ${VWC_REALM_RUNTIME}/${VWC_ECOSYSTEM_RUNTIME}.*
  do
    folderName=$(basename $f)
    if [[ "$folderName" != *".backup."* ]] ; then
      executionplane --silent tar cvf "$repo/vcwc/assets/$folderName.tar" "${VWC_REALM_RUNTIME}/$folderName"
    fi
  done;
  config set-version $(date +"%Y%m%d") $repo
fi
