#!/usr/bin/env bash
(
  export PATH="$VWC_EXECUTIONPLANE_APIINTERNALPATH_VCW"
  . executionplane-invoke "$0 $@"
  case $1 in
    --info)
      . info-summary console
    ;;
    backup|restore)
      console-backup-restore "$1" "$2"
    ;;
    clone-repo)
      repoName="$2"
      realm=$(echo ${repoName} | cut -d"/" -f1)
      if [[ ! -d /vcwc/pwd/${repoName} ]] ; then
        if [[ ! -d /vcwc/pwd/${realm} ]] ; then mkdir /vcwc/pwd/${realm}; chmod -R 777 /vcwc/pwd/${realm}; fi
        cd /vcwc/pwd/${realm}
        executionplane git clone https://github.com/${repoName}.git
        cd /vcwc/pwd/
        executionplane chmod -R 777 /vcwc/pwd/${repoName}
      else
        executionplane-warning "Repository folder already exists!"
      fi
    ;;
    cmd)
      shift
      executionplane $@
    ;;
    controlplane-service)
      shift
      controlplane-service $@
    ;;
    extract)
      repoName="$2"
      if [[ "$3" == "--reload" ]] ; then
        executionplane docker image pull ${VWC_REGISTRY}${repoName}
        if [[ "${VCW_REGISTRY}" != "" ]] ; then executionplane docker tag ${VWC_REGISTRY}${repoName} ${repoName}; fi
      fi
			. executionplane-capture-output docker create ${repoName}
			executionplane mkdir -p /vcwc/pwd/${repoName}
			executionplane docker container cp $VWC_EXECUTIONPLANE_OUTPUT:/vcw/repo. /vcwc/pwd/${repoName}
		;;
    load)
      repoName="$2"
      executionplane docker image pull ${VCW_REGISTRY}${repoName}
      if [[ "${VCW_REGISTRY}" != "" ]] ; then executionplane docker tag ${VWC_REGISTRY}${repoName} ${repoName}; fi
    ;;
    reset)
      echo "" > /vcw/pwd/current-console-selection
    ;;
    set)
      echo "$2" > ./current-console-selection
    ;;
    set-repo-user)
			executionplane git config --global user.name "$2"
			executionplane git config --global user.email "$3"
      executionplane git config --global core.filemode false
		;;
    start-registry)
      port="$2"
      if [[ "$port" == "" ]] ; then
        port="5000"
      fi
      executionplane docker run -d -p ${port}:5000 --restart=always --name vcwc_registry_base_2 -v vcwc_registry_base_2_data:/var/lib/registry ${VWC_REGISTRY}vcwc/registry.base:2
		;;
    stop-registry)
      executionplane docker container rm --force vcwc_registry_base_2
      executionplane docker volume rm --force vcwc_registry_base_2_data
    ;;
    unload)
      repoName="$2"
      executionplane docker image rm --force ${VCW_REGISTRY}${repoName}
      if [[ "${VCW_REGISTRY}" != "" ]] ; then executionplane docker image rm --force ${VCW_REGISTRY}${repoName}; fi
    ;;
   *)
      executionplane-error "Method not recognised: $1."
    ;;
  esac
  executionplane-complete
)
