#!/usr/bin/env bash
(
	export PATH="$VCWC_EXECUTIONPLANE_APIINTERNALPATH_VCWC"
	. executionplane-invoke "$0 $@"
	imageName="${@: -1}"
	rootPath="/vcwc/pwd/${imageName}"
	. invoke-script $imageName environment

	# deep build down to base included
	if [[ $1 == "--deep" ]] ; then
		baseImage=$(echo ${VCWC_BASE} | cut -f1 -d":")
		build ${@:1:$#-1} ${VCWC_REALM_RUNTIME}/${VCWC_ECOSYSTEM_RUNTIME}.$baseImage
	fi

	case $1 in
		--info)
			. info-summary build
		;;
		*)
			# build latest image
			tmpfile=$(mktemp /tmp/Dockerfile.XXXXXX)
			cat $rootPath/Dockerfile | envsubst > $tmpfile
			executionplane "--errors-only" docker build -t "$VCWC_REGISTRY$imageName" -f $tmpfile $rootPath
			rm $tmpfile

			# tag latest image
			if [[ "${VCWC_TAG}" != "" ]] ; then
				executionplane "--errors-only" docker tag "$VCWC_REGISTRY$imageName" "$VCWC_REGISTRY$imageName:${VCWC_TAG}"
			fi
		;;
	esac
  executionplane-complete
)
